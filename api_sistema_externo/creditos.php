<?php
// Incluir el archivo de configuración para la conexión a la base de datos
include 'config.php';

// Obtener el DNI de la solicitud
if (isset($_GET['dni'])) {
    $dni = $_GET['dni'];

    // Verificar si se está solicitando limpiar el historial
    if (isset($_GET['limpiar']) && $_GET['limpiar'] == 'true') {
        // Actualizar el estado de todas las transacciones a "Pagado" en la base de datos
        $sql = "UPDATE creditos SET estado = 'Pagado' WHERE dni = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("s", $dni);
        if ($stmt->execute()) {
            echo "Historial crediticio limpiado correctamente.";
        } else {
            echo "Error al limpiar el historial crediticio: " . $conn->error;
        }
    } else {
        // Consultar el historial crediticio desde la base de datos
        $sql = "SELECT fecha, monto, estado FROM creditos WHERE dni = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("s", $dni);
        $stmt->execute();
        $result = $stmt->get_result();

        if ($result->num_rows > 0) {
            $historial = [];
            while ($row = $result->fetch_assoc()) {
                $historial[] = $row;
            }
            // Devolver el historial crediticio en formato JSON
            header('Content-Type: application/json');
            echo json_encode($historial);
        } else {
            // Si el DNI no tiene historial crediticio, devolver una respuesta vacía
            header('Content-Type: application/json');
            echo json_encode([]);
        }
    }
} else {
    // Si no se proporciona un DNI, devolver un error
    header('HTTP/1.1 400 Bad Request');
    echo json_encode(['error' => 'DNI no proporcionado']);
}

// Cerrar la conexión a la base de datos
$conn->close();
?>