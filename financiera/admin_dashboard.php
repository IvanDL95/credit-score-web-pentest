<?php
session_start();
include 'config.php';

if (!isset($_SESSION['username'])) {
    header('Location: index.html');
    exit();
}

$username = $_SESSION['username'];

// Consultar si el usuario es administrador
$sql = "SELECT es_admin FROM usuarios WHERE username = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("s", $username);
$stmt->execute();
$stmt->bind_result($es_admin);
$stmt->fetch();
$stmt->close();

if (!$es_admin) {
    // Si el usuario no es administrador, redirigir al dashboard de usuario
    header('Location: dashboard.php');
    exit();
}

// Función para obtener el historial crediticio de un usuario desde la API externa simulada
function obtenerHistorialCrediticioExternoSimulado($dni) {
    $url = 'http://localhost:8080/api_sistema_externo/creditos.php?dni=' . rawurldecode($dni);


    // Inicializar cURL
    $ch = curl_init($url);

    // Configurar opciones de cURL
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    // Ejecutar la solicitud
    $response = curl_exec($ch);

    // Verificar errores de cURL
    if (curl_errno($ch)) {
        echo 'Error al conectar con la API: ' . curl_error($ch);
        curl_close($ch);
        return null;
    }

    // Obtener el código de respuesta HTTP
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    // Cerrar la conexión cURL
    curl_close($ch);

    if ($http_code != 200) {
        echo 'Error: API devolvió el código de respuesta ' . $http_code;
        return null;
    }

    // Decodificar la respuesta JSON
    $data = json_decode($response, true);

    // Verificar si la decodificación fue exitosa
    if (json_last_error() !== JSON_ERROR_NONE) {
        echo 'Error al decodificar la respuesta JSON: ' . json_last_error_msg();
        return null;
    }

    return $data;
}
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        $dni_consulta = $_POST['dni'];
        $historial_crediticio = obtenerHistorialCrediticioExternoSimulado($dni_consulta);
    } else {
        $historial_crediticio = null;
    }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financiera - Admin Dashboard</title>
</head>
<body>
    <h1>Bienvenido, <?php echo htmlspecialchars($username); ?></h1>
    <h2>Consultar Historial Crediticio de Usuarios</h2>
    <form method="post" action="admin_dashboard.php">
        <label for="dni">DNI del Usuario:</label>
        <input type="text" id="dni" name="dni">
        <button type="submit">Consultar</button>
    </form>
    <?php if ($historial_crediticio !== null): ?>
        <?php if (empty($historial_crediticio)): ?>
            <p>No se encontró historial crediticio para el DNI ingresado.</p>
        <?php else: ?>
            <table border="1">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($historial_crediticio as $credito): ?>
                    <tr>
                        <td><?php echo htmlspecialchars($credito['fecha']); ?></td>
                        <td><?php echo htmlspecialchars($credito['monto']); ?></td>
                        <td><?php echo htmlspecialchars($credito['estado']); ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    <?php endif; ?>
</body>
</html>